rules:
  - name: Flutter Version Alignment
    description: Mandatory Flutter version alignment requirement for any Flutter project analysis (single app or multi-app monorepos). Ensures global Flutter version matches project requirements.
    match: "*"
    prompt: |
      MANDATORY: Execute Flutter Version Alignment Requirement before any Flutter project analysis.

      This rule applies to ANY Flutter project regardless of versions found:

      MONOREPO DETECTION:
      - First detect repository structure: single app (app/) or multi-app monorepo (apps/app1/, apps/app2/, etc.)
      - If apps/ directory exists, analyze each app individually
      - If packages/ directory exists, analyze each package individually

      SINGLE APP VERSION ALIGNMENT:
      1. **Extract Project Flutter Version**:
         - Read `app/pubspec.yaml` and extract the Flutter SDK version constraint from environment.sdk.flutter
         - Check for `app/.fvm/fvm_config.json` or `app/.fvmrc` files for FVM-specific version
         - Identify the exact Flutter version the project requires

      2. **Check Current Global Flutter Version**:
         - Run `flutter --version` to get current global Flutter version
         - Compare with project requirement

      3. **Version Mismatch Detection**:
         - If versions differ (even minor/patch differences): ALIGNMENT REQUIRED
         - If versions match: Continue with analysis
         - If FVM is configured but not installed: Install FVM and configure

      4. **Execute Version Alignment**:
         - Install required Flutter version globally (using FVM if available, or direct installation)
         - Switch global Flutter to project version
         - Verify alignment with `flutter --version`
         - Clean project dependencies: `flutter clean && flutter pub get`

      MULTI-APP MONOREPO VERSION ALIGNMENT:
      1. **Extract Project Flutter Versions**:
         - Read root `pubspec.yaml` (if exists) and extract Flutter SDK version constraint
         - Check for root-level `.fvm/fvm_config.json` or `.fvmrc` files
         - For each app in apps/ directory:
           - Read `apps/<app_name>/pubspec.yaml` and extract Flutter SDK version constraint
           - Check for `apps/<app_name>/.fvm/fvm_config.json` or `apps/<app_name>/.fvmrc` files
         - For each package in packages/ directory:
           - Read `packages/<package_name>/pubspec.yaml` and extract Flutter SDK version constraint
           - Check for `packages/<package_name>/.fvm/fvm_config.json` or `packages/<package_name>/.fvmrc` files

      2. **Version Consistency Analysis**:
         - Compare Flutter versions across all apps and packages
         - Identify version conflicts between apps/packages
         - Determine the target Flutter version (most common or highest)

      3. **Check Current Global Flutter Version**:
         - Run `flutter --version` to get current global Flutter version
         - Compare with target project requirement

      4. **Version Mismatch Detection**:
         - If versions differ (even minor/patch differences): ALIGNMENT REQUIRED
         - If versions match: Continue with analysis
         - If FVM is configured but not installed: Install FVM and configure
         - Note any version inconsistencies between apps/packages

      5. **Execute Version Alignment**:
         - Install required Flutter version globally (using FVM if available, or direct installation)
         - Switch global Flutter to target project version
         - Verify alignment with `flutter --version`
         - Clean project dependencies for each app: `cd apps/<app_name> && flutter clean && flutter pub get`
         - Clean project dependencies for each package: `cd packages/<package_name> && flutter clean && flutter pub get`
         - Clean root dependencies if applicable: `flutter clean && flutter pub get`

      6. **Documentation**:
         - Log the version change process
         - Document any alignment issues or failures
         - Document version consistency across apps/packages
         - Note any version conflicts that require resolution

      IMPORTANT: If any error occurs during Flutter version verification or installation:
      - Log the specific error and reason for failure
      - Note missing FVM files/folders (.fvm/, .fvm/fvm_config.json, .fvmrc)
      - Continue execution with a warning that environment setup failed
      - Document the failure reason for inclusion in the final report
      - Do NOT stop execution - proceed to subsequent steps

      Why This Is Critical:
      - Prevents Build Failures: Version mismatches cause compilation errors
      - Ensures Accurate Analysis: Different Flutter versions have different capabilities
      - Maintains Consistency: All team members should use the same Flutter version
      - Avoids False Positives: Analysis results depend on the correct Flutter version
      - Multi-app Consistency: Ensures all apps in monorepo use compatible Flutter versions
